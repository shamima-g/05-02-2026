openapi: 3.1.0
info:
  title: InvestInsight API
  description: |
    Portfolio Reporting & Data Stewardship Platform API.

    This API provides access to the InvestInsight SQL Server database for:
    - Master data management (instruments, portfolios, asset managers)
    - Reference data (currencies, countries, indexes, benchmarks)
    - Workflow management (report batches, approvals)
    - File processing status
    - Risk metrics and calculations

    **Authentication**: External (AD/LDAP) - see /auth endpoints
    **Audit**: Temporal tables provide automatic history - use ?asOf parameter for point-in-time queries
  version: 1.0.0
  contact:
    name: Investment Operations

servers:
  - url: http://localhost:5000/api/v1
    description: Development server
  - url: https://investinsight.example.com/api/v1
    description: Production server

tags:
  - name: Auth
    description: Authentication and authorization (external AD/LDAP integration)
  - name: Users
    description: User management and lifecycle
  - name: Roles
    description: Role and permission management
  - name: ApprovalAuthority
    description: Configure approval authorities at each level
  - name: ReportBatches
    description: Workflow batches for monthly/weekly reporting
  - name: Approvals
    description: Multi-level approval workflow
  - name: Instruments
    description: Instrument master data management
  - name: Portfolios
    description: Portfolio master data
  - name: AssetManagers
    description: Asset manager reference data
  - name: Holdings
    description: Portfolio holdings per batch
  - name: CreditRatings
    description: Instrument credit ratings
  - name: RiskMetrics
    description: Duration, YTM, and Beta metrics
  - name: IndexPrices
    description: Benchmark index pricing
  - name: Files
    description: File processing and status
  - name: ReferenceData
    description: Currencies, countries, benchmarks, indexes
  - name: Calculations
    description: Calculated results (performance, fees)
  - name: Dashboard
    description: Aggregation endpoints for the role-based dashboard home screen
  - name: Audit
    description: Audit trail access and login activity monitoring

paths:
  # ============================================
  # AUTHENTICATION (External AD/LDAP)
  # ============================================
  /auth/login:
    post:
      tags: [Auth]
      summary: Authenticate user
      description: Authenticate against external directory (AD/LDAP)
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Authentication successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/me:
    get:
      tags: [Auth]
      summary: Get current user info
      operationId: getCurrentUser
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current user details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  /auth/refresh:
    post:
      tags: [Auth]
      summary: Refresh access token
      operationId: refreshToken
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                refreshToken:
                  type: string
              required: [refreshToken]
      responses:
        '200':
          description: New tokens
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'

  /auth/session:
    get:
      tags: [Auth]
      summary: Get current session info
      description: Retrieve current session details including user info, permissions, and session expiration
      operationId: getSession
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current session details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/logout:
    post:
      tags: [Auth]
      summary: Terminate current session
      description: Invalidate the current session and clear server-side session data
      operationId: logout
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Session terminated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Session terminated successfully
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/permissions:
    get:
      tags: [Auth]
      summary: Get all permissions for current user
      description: Returns the full list of permissions for the authenticated user based on their assigned roles
      operationId: getPermissions
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PermissionsResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ============================================
  # USER MANAGEMENT
  # ============================================
  /users:
    get:
      tags: [Users]
      summary: List users
      operationId: listUsers
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PageSizeParam'
        - name: isActive
          in: query
          schema:
            type: boolean
        - name: search
          in: query
          description: Search by username, display name, or email
          schema:
            type: string
        - name: department
          in: query
          description: Filter by department
          schema:
            type: string
        - name: roleId
          in: query
          description: Filter by role ID
          schema:
            type: integer
      responses:
        '200':
          description: List of users
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserList'
        '403':
          $ref: '#/components/responses/Forbidden'

    post:
      tags: [Users]
      summary: Create user
      operationId: createUser
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserRequest'
      responses:
        '201':
          description: User created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserDetail'
        '400':
          description: Validation error (e.g., username already exists)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          $ref: '#/components/responses/Forbidden'

  /users/{id}:
    get:
      tags: [Users]
      summary: Get user details
      operationId: getUser
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: User details with roles
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserDetail'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags: [Users]
      summary: Update user
      operationId: updateUser
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequest'
      responses:
        '200':
          description: User updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserDetail'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /users/{id}/deactivate:
    post:
      tags: [Users]
      summary: Deactivate user
      description: |
        Soft delete - user cannot be hard deleted per audit requirements.
        A reason must be provided for the audit trail.
        If the user is an approver with pending approvals, a transferApprovalsTo user ID must be specified.
      operationId: deactivateUser
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeactivateUserRequest'
      responses:
        '200':
          description: User deactivated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserDetail'
        '400':
          description: Validation error (e.g., missing reason or transfer target)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          $ref: '#/components/responses/Forbidden'

  /users/{id}/reactivate:
    post:
      tags: [Users]
      summary: Reactivate user
      operationId: reactivateUser
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: User reactivated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserDetail'
        '403':
          $ref: '#/components/responses/Forbidden'

  /users/{id}/roles:
    get:
      tags: [Users]
      summary: Get user roles
      operationId: getUserRoles
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: User's assigned roles
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Role'

    put:
      tags: [Users]
      summary: Update user roles
      description: Replace all user roles with the provided list. Supports optional effective date for scheduled role changes and reason for audit trail compliance.
      operationId: updateUserRoles
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                roleIds:
                  type: array
                  items:
                    type: integer
                  description: Array of role IDs to assign to the user
                effectiveDate:
                  type: string
                  format: date
                  description: Date when the role assignment takes effect. If omitted, changes take effect immediately.
                  example: '2026-01-06'
                reason:
                  type: string
                  maxLength: 500
                  description: Reason for the role change (required for audit trail per BR-SEC-005)
                  example: 'Promotion to team lead role'
              required: [roleIds, reason]
      responses:
        '200':
          description: Roles updated
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Role'
        '403':
          $ref: '#/components/responses/Forbidden'

  /users/{id}/activity:
    get:
      tags: [Users, Audit]
      summary: Get user activity log
      operationId: getUserActivity
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PageSizeParam'
        - name: from
          in: query
          schema:
            type: string
            format: date-time
        - name: to
          in: query
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: User activity
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserActivityList'

  /users/{id}/history:
    get:
      tags: [Users, Audit]
      summary: Get user change history
      operationId: getUserHistory
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: User change history from temporal table
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/UserHistoryEntry'

  /users/export:
    get:
      tags: [Users]
      summary: Export user list to Excel
      operationId: exportUsers
      security:
        - bearerAuth: []
      parameters:
        - name: format
          in: query
          schema:
            type: string
            enum: [xlsx, csv]
            default: xlsx
        - name: isActive
          in: query
          description: Filter by active/inactive status
          schema:
            type: boolean
        - name: search
          in: query
          description: Filter by name, email, or username
          schema:
            type: string
      responses:
        '200':
          description: Excel file
          content:
            application/vnd.openxmlformats-officedocument.spreadsheetml.sheet:
              schema:
                type: string
                format: binary
        '403':
          $ref: '#/components/responses/Forbidden'

  # ============================================
  # ROLES AND PERMISSIONS
  # ============================================
  /roles:
    get:
      tags: [Roles]
      summary: List roles
      operationId: listRoles
      security:
        - bearerAuth: []
      responses:
        '200':
          description: All roles with permissions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/RoleWithPermissions'

    post:
      tags: [Roles]
      summary: Create custom role
      description: System roles cannot be created, only custom roles
      operationId: createRole
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRoleRequest'
      responses:
        '201':
          description: Role created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RoleWithPermissions'
        '403':
          $ref: '#/components/responses/Forbidden'

  /roles/{id}:
    get:
      tags: [Roles]
      summary: Get role details
      operationId: getRole
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: Role with permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RoleWithPermissions'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags: [Roles]
      summary: Update role permissions
      description: System roles can have permissions modified but not deleted
      operationId: updateRole
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateRoleRequest'
      responses:
        '200':
          description: Role updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RoleWithPermissions'
        '403':
          $ref: '#/components/responses/Forbidden'

  /permissions:
    get:
      tags: [Roles]
      summary: List all permissions
      operationId: listPermissions
      security:
        - bearerAuth: []
      responses:
        '200':
          description: All available permissions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Permission'

  # ============================================
  # APPROVAL AUTHORITY
  # ============================================
  /approval-authorities:
    get:
      tags: [ApprovalAuthority]
      summary: List approval authorities
      operationId: listApprovalAuthorities
      security:
        - bearerAuth: []
      parameters:
        - name: level
          in: query
          schema:
            type: integer
            enum: [1, 2, 3]
        - name: activeOnly
          in: query
          schema:
            type: boolean
            default: true
      responses:
        '200':
          description: Approval authorities by level
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ApprovalAuthorityEntry'

    post:
      tags: [ApprovalAuthority]
      summary: Assign approval authority
      operationId: assignApprovalAuthority
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateApprovalAuthorityRequest'
      responses:
        '201':
          description: Authority assigned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApprovalAuthorityEntry'
        '400':
          description: Validation error (e.g., user cannot approve own work)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          $ref: '#/components/responses/Forbidden'

  /approval-authorities/{id}:
    put:
      tags: [ApprovalAuthority]
      summary: Update approval authority
      description: Update approval authority record (e.g., mark out-of-office, change effective dates)
      operationId: updateApprovalAuthority
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateApprovalAuthorityRequest'
      responses:
        '200':
          description: Authority updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApprovalAuthorityEntry'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags: [ApprovalAuthority]
      summary: Remove approval authority
      operationId: removeApprovalAuthority
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '204':
          description: Authority removed
        '400':
          description: Cannot remove - user has pending approvals
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /approval-authorities/{id}/backup:
    post:
      tags: [ApprovalAuthority]
      summary: Configure backup approver
      description: Set one or more backup approvers for a primary approver
      operationId: configureBackupApprover
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfigureBackupRequest'
      responses:
        '200':
          description: Backup approver(s) configured
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApprovalAuthorityEntry'
        '400':
          description: Validation error (e.g., backup must have same or higher level)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /approval-authorities/active:
    get:
      tags: [ApprovalAuthority]
      summary: Get currently active approvers
      description: Get all currently active approvers per level (excludes OOO and inactive)
      operationId: getActiveApprovers
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Active approvers grouped by level
          content:
            application/json:
              schema:
                type: object
                properties:
                  level1:
                    type: array
                    items:
                      $ref: '#/components/schemas/ApproverSummary'
                  level2:
                    type: array
                    items:
                      $ref: '#/components/schemas/ApproverSummary'
                  level3:
                    type: array
                    items:
                      $ref: '#/components/schemas/ApproverSummary'

  /approval-authorities/rules:
    get:
      tags: [ApprovalAuthority]
      summary: Get approval rules configuration
      description: Get the current approval rule for each level
      operationId: getApprovalRules
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Approval rules by level
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ApprovalRulesConfig'

    put:
      tags: [ApprovalAuthority]
      summary: Update approval rules configuration
      description: Update the approval rule for a specific level
      operationId: updateApprovalRules
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ApprovalRulesConfig'
      responses:
        '200':
          description: Rules updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApprovalRulesConfig'
        '403':
          $ref: '#/components/responses/Forbidden'

  /approval-authorities/by-level/{level}:
    get:
      tags: [ApprovalAuthority]
      summary: Get approvers for a specific level
      operationId: getApproversByLevel
      security:
        - bearerAuth: []
      parameters:
        - name: level
          in: path
          required: true
          schema:
            type: integer
            enum: [1, 2, 3]
      responses:
        '200':
          description: Primary and backup approvers for the level
          content:
            application/json:
              schema:
                type: object
                properties:
                  level:
                    type: integer
                  primary:
                    type: array
                    items:
                      $ref: '#/components/schemas/ApproverSummary'
                  backup:
                    type: array
                    items:
                      $ref: '#/components/schemas/ApproverSummary'

  # ============================================
  # REPORT BATCHES (Workflow)
  # ============================================
  /report-batches:
    get:
      tags: [ReportBatches]
      summary: List report batches
      operationId: listReportBatches
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PageSizeParam'
        - name: type
          in: query
          schema:
            type: string
            enum: [Monthly, Weekly]
        - name: year
          in: query
          schema:
            type: integer
        - name: status
          in: query
          schema:
            type: string
            enum: [DataPreparation, Level1Pending, Level2Pending, Level3Pending, Approved, Rejected]
      responses:
        '200':
          description: List of report batches
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReportBatchList'

    post:
      tags: [ReportBatches]
      summary: Create new report batch
      operationId: createReportBatch
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateReportBatchRequest'
      responses:
        '201':
          description: Batch created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReportBatch'

  /report-batches/{id}:
    get:
      tags: [ReportBatches]
      summary: Get report batch details
      operationId: getReportBatch
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: Batch details with status summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReportBatchDetail'
        '404':
          $ref: '#/components/responses/NotFound'

  /report-batches/{id}/status:
    get:
      tags: [ReportBatches]
      summary: Get batch workflow status
      description: Returns current workflow state, approval status, and data completeness
      operationId: getReportBatchStatus
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: Workflow status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchWorkflowStatus'

  /report-batches/{id}/validation:
    get:
      tags: [ReportBatches]
      summary: Get data validation summary
      description: Returns completeness checks for files, portfolios, and reference data
      operationId: getBatchValidation
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: Validation results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchValidationResult'

  /report-batches/{id}/confirm:
    post:
      tags: [ReportBatches]
      summary: Confirm data preparation complete
      description: Locks data entry and initiates calculations
      operationId: confirmBatch
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: Batch confirmed, calculations initiated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReportBatch'

  # ============================================
  # APPROVALS
  # ============================================
  /report-batches/{id}/approvals:
    get:
      tags: [Approvals]
      summary: Get approval history for batch
      operationId: getBatchApprovals
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: Approval history
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ApprovalLogEntry'

    post:
      tags: [Approvals]
      summary: Submit approval decision
      operationId: submitApproval
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ApprovalRequest'
      responses:
        '200':
          description: Approval recorded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApprovalLogEntry'
        '400':
          description: Invalid approval (wrong level, already approved, etc.)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ============================================
  # INSTRUMENTS
  # ============================================
  /instruments:
    get:
      tags: [Instruments]
      summary: List instruments
      operationId: listInstruments
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PageSizeParam'
        - $ref: '#/components/parameters/AsOfParam'
        - name: search
          in: query
          description: Search by ISIN, code, or name
          schema:
            type: string
        - name: securityType
          in: query
          schema:
            type: string
        - name: countryId
          in: query
          schema:
            type: integer
        - name: isActive
          in: query
          schema:
            type: boolean
            default: true
      responses:
        '200':
          description: Paginated list of instruments
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InstrumentList'

    post:
      tags: [Instruments]
      summary: Create instrument
      operationId: createInstrument
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateInstrumentRequest'
      responses:
        '201':
          description: Instrument created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Instrument'

  /instruments/{id}:
    get:
      tags: [Instruments]
      summary: Get instrument details
      operationId: getInstrument
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
        - $ref: '#/components/parameters/AsOfParam'
      responses:
        '200':
          description: Instrument details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Instrument'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags: [Instruments]
      summary: Update instrument
      operationId: updateInstrument
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateInstrumentRequest'
      responses:
        '200':
          description: Instrument updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Instrument'

  /instruments/{id}/history:
    get:
      tags: [Instruments, Audit]
      summary: Get instrument change history
      operationId: getInstrumentHistory
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
        - name: from
          in: query
          schema:
            type: string
            format: date-time
        - name: to
          in: query
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Change history from temporal table
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/InstrumentHistoryEntry'

  /instruments/export:
    get:
      tags: [Instruments]
      summary: Export instruments to Excel
      operationId: exportInstruments
      security:
        - bearerAuth: []
      parameters:
        - name: format
          in: query
          schema:
            type: string
            enum: [xlsx, csv]
            default: xlsx
        - name: missingOnly
          in: query
          description: Export only instruments missing required data
          schema:
            type: boolean
      responses:
        '200':
          description: Excel file
          content:
            application/vnd.openxmlformats-officedocument.spreadsheetml.sheet:
              schema:
                type: string
                format: binary

  # ============================================
  # PORTFOLIOS
  # ============================================
  /portfolios:
    get:
      tags: [Portfolios]
      summary: List portfolios
      operationId: listPortfolios
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PageSizeParam'
        - name: assetManagerId
          in: query
          schema:
            type: integer
        - name: currencyId
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: List of portfolios
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PortfolioList'

    post:
      tags: [Portfolios]
      summary: Create portfolio
      operationId: createPortfolio
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePortfolioRequest'
      responses:
        '201':
          description: Portfolio created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Portfolio'

  /portfolios/{id}:
    get:
      tags: [Portfolios]
      summary: Get portfolio details
      operationId: getPortfolio
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: Portfolio details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Portfolio'

    put:
      tags: [Portfolios]
      summary: Update portfolio
      operationId: updatePortfolio
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePortfolioRequest'
      responses:
        '200':
          description: Portfolio updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Portfolio'

  # ============================================
  # HOLDINGS
  # ============================================
  /report-batches/{batchId}/holdings:
    get:
      tags: [Holdings]
      summary: List holdings for a batch
      operationId: listHoldings
      security:
        - bearerAuth: []
      parameters:
        - name: batchId
          in: path
          required: true
          schema:
            type: integer
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PageSizeParam'
        - name: portfolioId
          in: query
          schema:
            type: integer
        - name: instrumentId
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: Holdings list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HoldingList'

  /report-batches/{batchId}/holdings/custom:
    post:
      tags: [Holdings]
      summary: Add custom holding
      description: Manually add holding not from automated feeds
      operationId: createCustomHolding
      security:
        - bearerAuth: []
      parameters:
        - name: batchId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCustomHoldingRequest'
      responses:
        '201':
          description: Custom holding created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Holding'

  # ============================================
  # CREDIT RATINGS
  # ============================================
  /report-batches/{batchId}/credit-ratings:
    get:
      tags: [CreditRatings]
      summary: List credit ratings for batch
      operationId: listCreditRatings
      security:
        - bearerAuth: []
      parameters:
        - name: batchId
          in: path
          required: true
          schema:
            type: integer
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PageSizeParam'
        - name: instrumentId
          in: query
          schema:
            type: integer
        - name: missingOnly
          in: query
          description: Only return instruments missing ratings
          schema:
            type: boolean
      responses:
        '200':
          description: Credit ratings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreditRatingList'

  /report-batches/{batchId}/credit-ratings/{id}:
    put:
      tags: [CreditRatings]
      summary: Update credit rating
      operationId: updateCreditRating
      security:
        - bearerAuth: []
      parameters:
        - name: batchId
          in: path
          required: true
          schema:
            type: integer
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateCreditRatingRequest'
      responses:
        '200':
          description: Rating updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreditRating'

  /report-batches/{batchId}/credit-ratings/changes:
    get:
      tags: [CreditRatings]
      summary: Get rating changes vs previous batch
      operationId: getCreditRatingChanges
      security:
        - bearerAuth: []
      parameters:
        - name: batchId
          in: path
          required: true
          schema:
            type: integer
        - name: changeType
          in: query
          schema:
            type: string
            enum: [upgrade, downgrade, all]
            default: all
      responses:
        '200':
          description: Rating changes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreditRatingChangeList'

  # ============================================
  # RISK METRICS (Duration, Beta)
  # ============================================
  /report-batches/{batchId}/instrument-durations:
    get:
      tags: [RiskMetrics]
      summary: List instrument durations for batch
      operationId: listInstrumentDurations
      security:
        - bearerAuth: []
      parameters:
        - name: batchId
          in: path
          required: true
          schema:
            type: integer
        - name: missingOnly
          in: query
          schema:
            type: boolean
      responses:
        '200':
          description: Duration metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InstrumentDurationList'

    post:
      tags: [RiskMetrics]
      summary: Create/update instrument duration
      operationId: upsertInstrumentDuration
      security:
        - bearerAuth: []
      parameters:
        - name: batchId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpsertInstrumentDurationRequest'
      responses:
        '200':
          description: Duration saved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InstrumentDuration'

  /report-batches/{batchId}/instrument-betas:
    get:
      tags: [RiskMetrics]
      summary: List instrument betas for batch
      operationId: listInstrumentBetas
      security:
        - bearerAuth: []
      parameters:
        - name: batchId
          in: path
          required: true
          schema:
            type: integer
        - name: missingOnly
          in: query
          schema:
            type: boolean
      responses:
        '200':
          description: Beta metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InstrumentBetaList'

    post:
      tags: [RiskMetrics]
      summary: Create/update instrument beta
      operationId: upsertInstrumentBeta
      security:
        - bearerAuth: []
      parameters:
        - name: batchId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpsertInstrumentBetaRequest'
      responses:
        '200':
          description: Beta saved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InstrumentBeta'

  # ============================================
  # INDEX PRICES
  # ============================================
  /report-batches/{batchId}/index-prices:
    get:
      tags: [IndexPrices]
      summary: List index prices for batch
      operationId: listIndexPrices
      security:
        - bearerAuth: []
      parameters:
        - name: batchId
          in: path
          required: true
          schema:
            type: integer
        - name: missingOnly
          in: query
          schema:
            type: boolean
      responses:
        '200':
          description: Index prices
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IndexPriceList'

    post:
      tags: [IndexPrices]
      summary: Create/update index price
      operationId: upsertIndexPrice
      security:
        - bearerAuth: []
      parameters:
        - name: batchId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpsertIndexPriceRequest'
      responses:
        '200':
          description: Price saved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IndexPrice'

  /report-batches/{batchId}/index-prices/bulk:
    post:
      tags: [IndexPrices]
      summary: Bulk upload index prices
      operationId: bulkUploadIndexPrices
      security:
        - bearerAuth: []
      parameters:
        - name: batchId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/UpsertIndexPriceRequest'
      responses:
        '200':
          description: Prices saved
          content:
            application/json:
              schema:
                type: object
                properties:
                  saved:
                    type: integer
                  errors:
                    type: array
                    items:
                      type: object
                      properties:
                        indexId:
                          type: integer
                        error:
                          type: string

  # ============================================
  # FILES
  # ============================================
  /report-batches/{batchId}/files:
    get:
      tags: [Files]
      summary: Get file status for batch
      operationId: getBatchFileStatus
      security:
        - bearerAuth: []
      parameters:
        - name: batchId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: File status by source and type
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchFileStatus'

  /report-batches/{batchId}/files/upload:
    post:
      tags: [Files]
      summary: Upload file manually
      operationId: uploadFile
      security:
        - bearerAuth: []
      parameters:
        - name: batchId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                fileSettingId:
                  type: integer
              required: [file, fileSettingId]
      responses:
        '202':
          description: File accepted for processing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileUploadResponse'

  /file-settings:
    get:
      tags: [Files]
      summary: List file settings
      operationId: listFileSettings
      security:
        - bearerAuth: []
      parameters:
        - name: sourceId
          in: query
          schema:
            type: integer
        - name: isActive
          in: query
          schema:
            type: boolean
      responses:
        '200':
          description: File settings
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/FileSetting'

  /file-logs:
    get:
      tags: [Files]
      summary: List file processing logs
      operationId: listFileLogs
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PageSizeParam'
        - name: batchId
          in: query
          schema:
            type: integer
        - name: isValid
          in: query
          schema:
            type: boolean
      responses:
        '200':
          description: File logs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileLogList'

  # ============================================
  # REFERENCE DATA
  # ============================================
  /asset-managers:
    get:
      tags: [AssetManagers]
      summary: List asset managers
      operationId: listAssetManagers
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Asset managers
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AssetManager'

    post:
      tags: [AssetManagers]
      summary: Create asset manager
      operationId: createAssetManager
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateAssetManagerRequest'
      responses:
        '201':
          description: Asset manager created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssetManager'

  /currencies:
    get:
      tags: [ReferenceData]
      summary: List currencies
      operationId: listCurrencies
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Currencies
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Currency'

  /countries:
    get:
      tags: [ReferenceData]
      summary: List countries
      operationId: listCountries
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Countries
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Country'

  /indexes:
    get:
      tags: [ReferenceData]
      summary: List indexes
      operationId: listIndexes
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Indexes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Index'

  /benchmarks:
    get:
      tags: [ReferenceData]
      summary: List benchmarks
      operationId: listBenchmarks
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Benchmarks
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Benchmark'

  /credit-rating-scales:
    get:
      tags: [ReferenceData]
      summary: List credit rating scales
      operationId: listCreditRatingScales
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Rating scales
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CreditRatingScale'

  # ============================================
  # CALCULATIONS
  # ============================================
  /report-batches/{batchId}/calculations:
    get:
      tags: [Calculations]
      summary: Get calculation status
      operationId: getCalculationStatus
      security:
        - bearerAuth: []
      parameters:
        - name: batchId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Calculation status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CalculationStatus'

    post:
      tags: [Calculations]
      summary: Trigger calculations
      operationId: triggerCalculations
      security:
        - bearerAuth: []
      parameters:
        - name: batchId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '202':
          description: Calculations initiated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  workflowInstanceId:
                    type: string

  /report-batches/{batchId}/calculations/errors:
    get:
      tags: [Calculations]
      summary: Get calculation errors
      operationId: getCalculationErrors
      security:
        - bearerAuth: []
      parameters:
        - name: batchId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Calculation errors
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CalculationError'

  # ============================================
  # REPORT COMMENTS
  # ============================================
  /report-batches/{batchId}/comments:
    get:
      tags: [ReportBatches]
      summary: List report comments
      operationId: listReportComments
      security:
        - bearerAuth: []
      parameters:
        - name: batchId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Comments
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ReportComment'

    post:
      tags: [ReportBatches]
      summary: Add report comment
      operationId: addReportComment
      security:
        - bearerAuth: []
      parameters:
        - name: batchId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateReportCommentRequest'
      responses:
        '201':
          description: Comment added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReportComment'

  # ============================================
  # DASHBOARD (Aggregation Endpoints)
  # ============================================
  /dashboard/pending-actions:
    get:
      tags: [Dashboard]
      summary: Get pending actions for current user
      description: |
        Returns role-specific pending actions requiring the current user's attention.
        The backend filters actions based on the authenticated user's roles:
        - **Analyst**: File status alerts, validation summaries, workflow progression tasks, outstanding master data items
        - **ApproverL1/L2/L3**: Batches awaiting the user's specific approval level only
        - **Administrator**: User management alerts and system configuration notifications
      operationId: getPendingActions
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of pending actions for the current user
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PendingAction'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /dashboard/activity:
    get:
      tags: [Dashboard]
      summary: Get recent system activity
      description: |
        Returns recent system activity filtered by the current user's role and permissions.
        Activities include file uploads, batch approvals, master data changes, and other
        workflow events relevant to the user.
      operationId: getDashboardActivity
      security:
        - bearerAuth: []
      parameters:
        - name: limit
          in: query
          description: Maximum number of activity entries to return
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 10
      responses:
        '200':
          description: List of recent activity entries
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DashboardActivity'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /dashboard/data-quality-summary:
    get:
      tags: [Dashboard]
      summary: Get data quality summary
      description: |
        Returns aggregated counts of missing or incomplete reference data across all
        active batches. Used by Operations Lead and Analyst roles to see outstanding
        data quality issues at a glance.
      operationId: getDataQualitySummary
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Summary of data quality issues
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DataQualitySummary'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ============================================
  # AUDIT
  # ============================================
  # ============================================
  # LOGIN ACTIVITY MONITORING
  # ============================================
  /audit/logins:
    get:
      tags: [Audit]
      summary: Get login attempt history
      description: |
        Returns paginated login attempt records with optional filtering by date range,
        status, and user. Supports sorting by timestamp. Includes IP geolocation data
        for UK and South Africa regions.
      operationId: getLoginActivity
      security:
        - bearerAuth: []
      parameters:
        - name: from
          in: query
          description: Start of date range filter (ISO 8601)
          schema:
            type: string
            format: date-time
        - name: to
          in: query
          description: End of date range filter (ISO 8601)
          schema:
            type: string
            format: date-time
        - name: status
          in: query
          description: Filter by login status
          schema:
            type: string
            enum: [all, success, failed]
            default: all
        - name: userId
          in: query
          description: Filter by specific user ID
          schema:
            type: integer
        - name: username
          in: query
          description: Filter by username (partial match)
          schema:
            type: string
        - name: sortBy
          in: query
          schema:
            type: string
            enum: [timestamp, username, status]
            default: timestamp
        - name: sortOrder
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: desc
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PageSizeParam'
      responses:
        '200':
          description: Paginated login activity records
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginActivityList'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /audit/logins/failed:
    get:
      tags: [Audit]
      summary: Get failed login attempts
      description: Returns only failed login attempts with failure reasons. Includes consecutive failure counts per user.
      operationId: getFailedLogins
      security:
        - bearerAuth: []
      parameters:
        - name: from
          in: query
          schema:
            type: string
            format: date-time
        - name: to
          in: query
          schema:
            type: string
            format: date-time
        - name: userId
          in: query
          schema:
            type: integer
        - name: failureReason
          in: query
          description: Filter by failure reason
          schema:
            type: string
            enum: [invalid_password, user_not_found, account_deactivated, account_locked]
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PageSizeParam'
      responses:
        '200':
          description: Failed login attempts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginActivityList'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /audit/logins/user/{userId}:
    get:
      tags: [Audit]
      summary: Get login history for specific user
      description: Returns login attempt history for a specific user, including both successful and failed attempts.
      operationId: getUserLoginHistory
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: integer
        - name: from
          in: query
          schema:
            type: string
            format: date-time
        - name: to
          in: query
          schema:
            type: string
            format: date-time
        - name: status
          in: query
          schema:
            type: string
            enum: [all, success, failed]
            default: all
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PageSizeParam'
      responses:
        '200':
          description: User login history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginActivityList'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /audit/logins/alerts:
    get:
      tags: [Audit]
      summary: Get security alerts
      description: |
        Returns active security alerts including:
        - Multiple failed login attempts from same IP (5+ in 5 minutes)
        - Account lockouts (3 consecutive failures)
        - Potential brute force attacks (10+ failed from different IPs in 1 hour)
        - New location logins
        - Impossible travel detections
      operationId: getLoginAlerts
      security:
        - bearerAuth: []
      parameters:
        - name: severity
          in: query
          description: Filter by alert severity
          schema:
            type: string
            enum: [all, critical, warning, info]
            default: all
        - name: active
          in: query
          description: Only return active (unresolved) alerts
          schema:
            type: boolean
            default: true
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PageSizeParam'
      responses:
        '200':
          description: Security alerts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SecurityAlertList'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /audit/logins/export:
    get:
      tags: [Audit]
      summary: Export login activity report
      description: Exports filtered login activity records as an Excel file. Columns include Timestamp, Username, User ID, Status, IP Address, Location, User Agent, Failure Reason.
      operationId: exportLoginActivity
      security:
        - bearerAuth: []
      parameters:
        - name: from
          in: query
          required: true
          schema:
            type: string
            format: date-time
        - name: to
          in: query
          required: true
          schema:
            type: string
            format: date-time
        - name: status
          in: query
          schema:
            type: string
            enum: [all, success, failed]
            default: all
        - name: userId
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: Excel file download
          content:
            application/vnd.openxmlformats-officedocument.spreadsheetml.sheet:
              schema:
                type: string
                format: binary
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /users/{id}/unlock:
    post:
      tags: [Users]
      summary: Manually unlock a locked user account
      description: |
        Allows an administrator to immediately unlock a user account that was
        automatically locked due to consecutive failed login attempts.
        The lockout timer is cleared and the user can attempt login immediately.
      operationId: unlockUserAccount
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
                  description: Administrator's reason for unlocking the account
      responses:
        '200':
          description: Account unlocked successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Account unlocked successfully
                  userId:
                    type: integer
                  unlockedAt:
                    type: string
                    format: date-time
                  unlockedBy:
                    type: string
                    description: Username of the administrator who unlocked the account
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  # ============================================
  # AUDIT TRAIL (existing)
  # ============================================
  /audit/changes:
    get:
      tags: [Audit]
      summary: Query audit trail
      operationId: queryAuditTrail
      security:
        - bearerAuth: []
      parameters:
        - name: entityType
          in: query
          required: true
          schema:
            type: string
            enum: [Instrument, Portfolio, AssetManager, Currency, Country, Index, CreditRating, InstrumentDuration, InstrumentBeta, IndexPrice]
        - name: entityId
          in: query
          schema:
            type: integer
        - name: from
          in: query
          schema:
            type: string
            format: date-time
        - name: to
          in: query
          schema:
            type: string
            format: date-time
        - name: user
          in: query
          schema:
            type: string
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PageSizeParam'
      responses:
        '200':
          description: Audit records
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditTrailList'

  /audit/export:
    get:
      tags: [Audit]
      summary: Export audit trail
      operationId: exportAuditTrail
      security:
        - bearerAuth: []
      parameters:
        - name: entityType
          in: query
          required: true
          schema:
            type: string
        - name: from
          in: query
          required: true
          schema:
            type: string
            format: date-time
        - name: to
          in: query
          required: true
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Excel export
          content:
            application/vnd.openxmlformats-officedocument.spreadsheetml.sheet:
              schema:
                type: string
                format: binary

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    IdParam:
      name: id
      in: path
      required: true
      schema:
        type: integer

    PageParam:
      name: page
      in: query
      schema:
        type: integer
        minimum: 1
        default: 1

    PageSizeParam:
      name: pageSize
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20

    AsOfParam:
      name: asOf
      in: query
      description: Point-in-time query for temporal tables
      schema:
        type: string
        format: date-time

  responses:
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Forbidden:
      description: Insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

  schemas:
    # ============================================
    # Common
    # ============================================
    Error:
      type: object
      properties:
        code:
          type: string
        message:
          type: string
        details:
          type: object
      required: [code, message]

    PaginationMeta:
      type: object
      properties:
        page:
          type: integer
        pageSize:
          type: integer
        totalItems:
          type: integer
        totalPages:
          type: integer

    # ============================================
    # Auth
    # ============================================
    LoginRequest:
      type: object
      properties:
        username:
          type: string
        password:
          type: string
      required: [username, password]

    AuthResponse:
      type: object
      properties:
        accessToken:
          type: string
        refreshToken:
          type: string
        expiresIn:
          type: integer
        user:
          $ref: '#/components/schemas/User'

    SessionResponse:
      type: object
      properties:
        userId:
          type: string
        username:
          type: string
        displayName:
          type: string
        roles:
          type: array
          items:
            type: string
            enum: [Analyst, ApproverL1, ApproverL2, ApproverL3, Administrator]
        permissions:
          type: array
          items:
            type: string
        expiresAt:
          type: string
          format: date-time
          description: Session expiration timestamp
        issuedAt:
          type: string
          format: date-time
          description: Session creation timestamp

    PermissionsResponse:
      type: object
      properties:
        userId:
          type: string
        roles:
          type: array
          items:
            type: string
        permissions:
          type: array
          items:
            type: string
            description: Permission strings in format 'resource.action' (e.g. 'batch.create', 'instrument.update')

    User:
      type: object
      properties:
        id:
          type: string
        username:
          type: string
        displayName:
          type: string
        email:
          type: string
        roles:
          type: array
          items:
            type: string
            enum: [Analyst, ApproverL1, ApproverL2, ApproverL3, Administrator]
        permissions:
          type: array
          items:
            type: string

    # ============================================
    # User Management
    # ============================================
    UserDetail:
      type: object
      properties:
        id:
          type: integer
        username:
          type: string
        firstName:
          type: string
        lastName:
          type: string
        displayName:
          type: string
        email:
          type: string
          nullable: true
        department:
          type: string
          nullable: true
        jobTitle:
          type: string
          nullable: true
        employeeId:
          type: string
          nullable: true
        managerId:
          type: integer
          nullable: true
        managerName:
          type: string
          nullable: true
        isActive:
          type: boolean
        deactivationReason:
          type: string
          nullable: true
          description: Reason for deactivation (populated when isActive=false)
        deactivatedAt:
          type: string
          format: date-time
          nullable: true
        roles:
          type: array
          items:
            $ref: '#/components/schemas/Role'
        lastLoginAt:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time
        lastChangedUser:
          type: string
        validFrom:
          type: string
          format: date-time
        validTo:
          type: string
          format: date-time

    UserList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/UserDetail'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    CreateUserRequest:
      type: object
      properties:
        username:
          type: string
          minLength: 3
          maxLength: 100
        firstName:
          type: string
          maxLength: 100
        lastName:
          type: string
          maxLength: 100
        displayName:
          type: string
          maxLength: 200
        email:
          type: string
          format: email
        department:
          type: string
          maxLength: 100
        jobTitle:
          type: string
          maxLength: 100
        managerId:
          type: integer
          nullable: true
          description: ID of the user's manager
        employeeId:
          type: string
          maxLength: 50
        roleIds:
          type: array
          items:
            type: integer
          minItems: 1
        forcePasswordChange:
          type: boolean
          default: true
          description: Require password change on first login
        sendWelcomeEmail:
          type: boolean
          default: false
          description: Send welcome email with login instructions
      required: [username, firstName, lastName, email, roleIds]

    UpdateUserRequest:
      type: object
      properties:
        firstName:
          type: string
          maxLength: 100
        lastName:
          type: string
          maxLength: 100
        displayName:
          type: string
          maxLength: 200
        email:
          type: string
          format: email
        department:
          type: string
          maxLength: 100
        jobTitle:
          type: string
          maxLength: 100
        managerId:
          type: integer
          nullable: true
        employeeId:
          type: string
          maxLength: 50

    DeactivateUserRequest:
      type: object
      properties:
        reason:
          type: string
          minLength: 1
          description: Reason for deactivation (required for audit trail)
        transferApprovalsTo:
          type: integer
          nullable: true
          description: User ID to transfer pending approvals to (required if user is an approver)
      required: [reason]

    UserHistoryEntry:
      allOf:
        - $ref: '#/components/schemas/UserDetail'
        - type: object
          properties:
            changeType:
              type: string
              enum: [Created, Updated, Deactivated, Reactivated]

    UserActivity:
      type: object
      properties:
        id:
          type: integer
        action:
          type: string
        entityType:
          type: string
          nullable: true
        entityId:
          type: integer
          nullable: true
        details:
          type: string
          nullable: true
        ipAddress:
          type: string
          nullable: true
        timestamp:
          type: string
          format: date-time

    UserActivityList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/UserActivity'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    # ============================================
    # Roles and Permissions
    # ============================================
    Role:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        description:
          type: string
          nullable: true
        isSystemRole:
          type: boolean
        allowedPages:
          type: array
          items:
            type: string
          description: List of frontend route paths this role can access (e.g. ["/batches", "/approvals/level-1"])

    RoleWithPermissions:
      allOf:
        - $ref: '#/components/schemas/Role'
        - type: object
          properties:
            permissions:
              type: array
              items:
                $ref: '#/components/schemas/Permission'

    Permission:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        description:
          type: string
          nullable: true
        category:
          type: string

    CreateRoleRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 3
          maxLength: 50
        description:
          type: string
          maxLength: 500
        permissionIds:
          type: array
          items:
            type: integer
        allowedPages:
          type: array
          items:
            type: string
          description: Frontend route paths this role can access
      required: [name, permissionIds, allowedPages]

    UpdateRoleRequest:
      type: object
      properties:
        description:
          type: string
          maxLength: 500
        permissionIds:
          type: array
          items:
            type: integer
        allowedPages:
          type: array
          items:
            type: string
          description: Frontend route paths this role can access
      required: [permissionIds, allowedPages]

    # ============================================
    # Approval Authority
    # ============================================
    ApprovalAuthorityEntry:
      type: object
      properties:
        id:
          type: integer
        userId:
          type: integer
        username:
          type: string
        displayName:
          type: string
        email:
          type: string
          nullable: true
        roleName:
          type: string
          description: "User's role name (e.g., 'Approver Level 1')"
        approvalLevel:
          type: integer
          enum: [1, 2, 3]
        isBackup:
          type: boolean
        isActive:
          type: boolean
        isOutOfOffice:
          type: boolean
          default: false
        outOfOfficeUntil:
          type: string
          format: date
          nullable: true
          description: Return date from out-of-office
        backupApprovers:
          type: array
          items:
            $ref: '#/components/schemas/ApproverSummary'
          description: Backup approvers designated for this primary approver
        effectiveFrom:
          type: string
          format: date
        effectiveTo:
          type: string
          format: date
          nullable: true
        assignedBy:
          type: string
        assignedAt:
          type: string
          format: date-time
        pendingApprovalCount:
          type: integer
          default: 0
          description: Number of batches awaiting this approver's approval

    CreateApprovalAuthorityRequest:
      type: object
      properties:
        userId:
          type: integer
        approvalLevel:
          type: integer
          enum: [1, 2, 3]
        isBackup:
          type: boolean
          default: false
        effectiveFrom:
          type: string
          format: date
        effectiveTo:
          type: string
          format: date
          nullable: true
      required: [userId, approvalLevel, effectiveFrom]

    UpdateApprovalAuthorityRequest:
      type: object
      properties:
        isActive:
          type: boolean
        isOutOfOffice:
          type: boolean
        outOfOfficeUntil:
          type: string
          format: date
          nullable: true
        effectiveTo:
          type: string
          format: date
          nullable: true

    ConfigureBackupRequest:
      type: object
      properties:
        backupUserIds:
          type: array
          items:
            type: integer
          description: User IDs of backup approvers to assign
      required: [backupUserIds]

    ApprovalRulesConfig:
      type: object
      properties:
        level:
          type: integer
          enum: [1, 2, 3]
        rule:
          type: string
          enum: [any_one, specific_assignee, consensus]
          description: |
            any_one - Any one approver can approve
            specific_assignee - Specific approver assigned per batch
            consensus - Requires consensus from 2+ approvers
        consensusRequired:
          type: integer
          nullable: true
          description: Number of approvals required when rule=consensus (default 2)
      required: [level, rule]

    ApproverSummary:
      type: object
      properties:
        userId:
          type: integer
        username:
          type: string
        displayName:
          type: string
        email:
          type: string
          nullable: true
        roleName:
          type: string
          nullable: true
        isOutOfOffice:
          type: boolean
          default: false
        outOfOfficeUntil:
          type: string
          format: date
          nullable: true

    # ============================================
    # Report Batch
    # ============================================
    ReportBatch:
      type: object
      properties:
        id:
          type: integer
        reportBatchType:
          type: string
          enum: [Monthly, Weekly]
        reportDate:
          type: string
          format: date
        workflowInstanceId:
          type: string
          nullable: true
        status:
          type: string
          enum: [DataPreparation, Level1Pending, Level2Pending, Level3Pending, Approved, Rejected]

    ReportBatchDetail:
      allOf:
        - $ref: '#/components/schemas/ReportBatch'
        - type: object
          properties:
            fileStatus:
              $ref: '#/components/schemas/BatchFileStatusSummary'
            dataCompleteness:
              $ref: '#/components/schemas/DataCompletenessSummary'
            approvalHistory:
              type: array
              items:
                $ref: '#/components/schemas/ApprovalLogEntry'
            calculationStatus:
              $ref: '#/components/schemas/CalculationStatusSummary'

    ReportBatchList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/ReportBatch'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    CreateReportBatchRequest:
      type: object
      properties:
        reportBatchType:
          type: string
          enum: [Monthly, Weekly]
        reportDate:
          type: string
          format: date
      required: [reportBatchType, reportDate]

    BatchWorkflowStatus:
      type: object
      properties:
        batchId:
          type: integer
        currentStage:
          type: string
        isLocked:
          type: boolean
        canConfirm:
          type: boolean
        canApprove:
          type: boolean
        pendingApprovalLevel:
          type: integer
          nullable: true
        lastUpdated:
          type: string
          format: date-time

    BatchValidationResult:
      type: object
      properties:
        isComplete:
          type: boolean
        fileCompleteness:
          type: object
          properties:
            expected:
              type: integer
            received:
              type: integer
            valid:
              type: integer
            failed:
              type: integer
        portfolioDataCompleteness:
          type: array
          items:
            type: object
            properties:
              portfolioId:
                type: integer
              portfolioName:
                type: string
              holdings:
                type: boolean
              transactions:
                type: boolean
              income:
                type: boolean
              cash:
                type: boolean
              performance:
                type: boolean
        referenceDataCompleteness:
          type: object
          properties:
            instrumentsMissingRatings:
              type: integer
            instrumentsMissingDurations:
              type: integer
            instrumentsMissingBetas:
              type: integer
            missingIndexPrices:
              type: integer

    BatchFileStatusSummary:
      type: object
      properties:
        total:
          type: integer
        received:
          type: integer
        valid:
          type: integer
        failed:
          type: integer
        pending:
          type: integer

    DataCompletenessSummary:
      type: object
      properties:
        portfoliosComplete:
          type: integer
        portfoliosIncomplete:
          type: integer
        missingRatings:
          type: integer
        missingDurations:
          type: integer
        missingBetas:
          type: integer
        missingIndexPrices:
          type: integer

    CalculationStatusSummary:
      type: object
      properties:
        status:
          type: string
          enum: [NotStarted, InProgress, Completed, Failed]
        completedCount:
          type: integer
        failedCount:
          type: integer

    # ============================================
    # Approvals
    # ============================================
    ApprovalLogEntry:
      type: object
      properties:
        id:
          type: integer
        reportBatchId:
          type: integer
        type:
          type: string
          enum: [Level1, Level2, Level3]
        isApproved:
          type: boolean
        user:
          type: string
        time:
          type: string
          format: date-time
        rejectReason:
          type: string
          nullable: true

    ApprovalRequest:
      type: object
      properties:
        level:
          type: integer
          enum: [1, 2, 3]
        isApproved:
          type: boolean
        rejectReason:
          type: string
          description: Required if isApproved is false
      required: [level, isApproved]

    # ============================================
    # Instrument
    # ============================================
    Instrument:
      type: object
      properties:
        id:
          type: integer
        isin:
          type: string
          nullable: true
        instrumentCode:
          type: string
          nullable: true
        bloombergTicker:
          type: string
          nullable: true
        cusip:
          type: string
          nullable: true
        sedol:
          type: string
          nullable: true
        name:
          type: string
          nullable: true
        shortName:
          type: string
          nullable: true
        description:
          type: string
          nullable: true
        ticker:
          type: string
          nullable: true
        parentCompanyName:
          type: string
          nullable: true
        securityType:
          type: string
          nullable: true
        securitySubType:
          type: string
          nullable: true
        marketSector:
          type: string
          nullable: true
        securityClass:
          type: string
          nullable: true
        issuerIndustry:
          type: string
          nullable: true
        countryId:
          type: integer
          nullable: true
        quotedCurrencyId:
          type: integer
          nullable: true
        amountIssued:
          type: number
          nullable: true
        couponType:
          type: string
          nullable: true
        coupon:
          type: number
          nullable: true
        couponFrequency:
          type: string
          nullable: true
        issueDate:
          type: string
          format: date
          nullable: true
        maturityDate:
          type: string
          format: date
          nullable: true
        issuerName:
          type: string
          nullable: true
        issuerCode:
          type: string
          nullable: true
        isCashEquivalent:
          type: boolean
          nullable: true
        lastChangedUser:
          type: string
        validFrom:
          type: string
          format: date-time
        validTo:
          type: string
          format: date-time

    InstrumentList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Instrument'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    CreateInstrumentRequest:
      type: object
      properties:
        isin:
          type: string
        instrumentCode:
          type: string
        name:
          type: string
        securityType:
          type: string
        countryId:
          type: integer
        quotedCurrencyId:
          type: integer
      required: [name]

    UpdateInstrumentRequest:
      type: object
      properties:
        isin:
          type: string
        instrumentCode:
          type: string
        name:
          type: string
        securityType:
          type: string
        countryId:
          type: integer
        quotedCurrencyId:
          type: integer
        maturityDate:
          type: string
          format: date
        coupon:
          type: number
        issuerName:
          type: string

    InstrumentHistoryEntry:
      allOf:
        - $ref: '#/components/schemas/Instrument'
        - type: object
          properties:
            changeType:
              type: string
              enum: [Created, Updated]

    # ============================================
    # Portfolio
    # ============================================
    Portfolio:
      type: object
      properties:
        id:
          type: integer
        assetManagerId:
          type: integer
        externalCode:
          type: string
        externalName:
          type: string
        code:
          type: string
        name:
          type: string
        currencyId:
          type: integer
        mandate:
          type: string
        mandateAppointedDate:
          type: string
          format: date
        mandateInceptionDate:
          type: string
          format: date
        objective:
          type: string
        fundStyle:
          type: string
        benchmarkId:
          type: integer
        minimumAcceptableReturnIndexId:
          type: integer
        lastChangedUser:
          type: string
        validFrom:
          type: string
          format: date-time
        validTo:
          type: string
          format: date-time

    PortfolioList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Portfolio'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    CreatePortfolioRequest:
      type: object
      properties:
        assetManagerId:
          type: integer
        externalCode:
          type: string
        externalName:
          type: string
        code:
          type: string
        name:
          type: string
        currencyId:
          type: integer
        mandate:
          type: string
        objective:
          type: string
        benchmarkId:
          type: integer
      required: [assetManagerId, code, name, currencyId, mandate, benchmarkId]

    UpdatePortfolioRequest:
      type: object
      properties:
        externalCode:
          type: string
        externalName:
          type: string
        name:
          type: string
        mandate:
          type: string
        objective:
          type: string
        benchmarkId:
          type: integer

    # ============================================
    # Holding
    # ============================================
    Holding:
      type: object
      properties:
        id:
          type: integer
        reportBatchId:
          type: integer
        portfolioId:
          type: integer
        instrumentId:
          type: integer
          nullable: true
        valuationDate:
          type: string
          format: date
        portfolioBaseCurrencyId:
          type: integer
        holdingNominal:
          type: number
        baseMarketValue:
          type: number
        baseBookValue:
          type: number
        baseUnrealisedProfitLoss:
          type: number

    HoldingList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Holding'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    CreateCustomHoldingRequest:
      type: object
      properties:
        portfolioId:
          type: integer
        instrumentId:
          type: integer
        valuationDate:
          type: string
          format: date
        holdingNominal:
          type: number
        baseMarketValue:
          type: number
      required: [portfolioId, instrumentId, valuationDate, holdingNominal, baseMarketValue]

    # ============================================
    # Credit Rating
    # ============================================
    CreditRating:
      type: object
      properties:
        id:
          type: integer
        reportBatchId:
          type: integer
        instrumentId:
          type: integer
        bbCompRating:
          type: string
          nullable: true
        fitchRating:
          type: string
          nullable: true
        moodysRating:
          type: string
          nullable: true
        sandPRating:
          type: string
          nullable: true
        fmInstrumentRating:
          type: string
          nullable: true
        fmIssuerRating:
          type: string
          nullable: true
        finalRatingNationalSource:
          type: string
          nullable: true
        finalRatingNational:
          type: string
          nullable: true
        finalRatingInternationalSource:
          type: string
          nullable: true
        finalRatingInternational:
          type: string
          nullable: true
        userNote:
          type: string
          nullable: true
        lastChangedUser:
          type: string

    CreditRatingList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/CreditRating'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    UpdateCreditRatingRequest:
      type: object
      properties:
        fmInstrumentRating:
          type: string
        fmIssuerRating:
          type: string
        userNote:
          type: string

    CreditRatingChange:
      type: object
      properties:
        instrumentId:
          type: integer
        instrumentName:
          type: string
        isin:
          type: string
        previousRating:
          type: string
        currentRating:
          type: string
        changeType:
          type: string
          enum: [Upgrade, Downgrade]
        ratingType:
          type: string
          enum: [National, International]

    CreditRatingChangeList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/CreditRatingChange'
        summary:
          type: object
          properties:
            upgrades:
              type: integer
            downgrades:
              type: integer

    # ============================================
    # Risk Metrics
    # ============================================
    InstrumentDuration:
      type: object
      properties:
        id:
          type: integer
        reportBatchId:
          type: integer
        instrumentId:
          type: integer
        modifiedDuration:
          type: number
          nullable: true
        yieldToMaturity:
          type: number
          nullable: true
        lastChangedUser:
          type: string

    InstrumentDurationList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/InstrumentDuration'
        meta:
          $ref: '#/components/schemas/PaginationMeta'
        outstandingCount:
          type: integer

    UpsertInstrumentDurationRequest:
      type: object
      properties:
        instrumentId:
          type: integer
        modifiedDuration:
          type: number
        yieldToMaturity:
          type: number
      required: [instrumentId]

    InstrumentBeta:
      type: object
      properties:
        id:
          type: integer
        reportBatchId:
          type: integer
        instrumentId:
          type: integer
        beta:
          type: number
        lastChangedUser:
          type: string

    InstrumentBetaList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/InstrumentBeta'
        meta:
          $ref: '#/components/schemas/PaginationMeta'
        outstandingCount:
          type: integer

    UpsertInstrumentBetaRequest:
      type: object
      properties:
        instrumentId:
          type: integer
        beta:
          type: number
      required: [instrumentId, beta]

    # ============================================
    # Index Price
    # ============================================
    IndexPrice:
      type: object
      properties:
        id:
          type: integer
        reportBatchId:
          type: integer
        indexId:
          type: integer
        price:
          type: number
        lastChangedUser:
          type: string

    IndexPriceList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/IndexPrice'
        meta:
          $ref: '#/components/schemas/PaginationMeta'
        outstandingCount:
          type: integer

    UpsertIndexPriceRequest:
      type: object
      properties:
        indexId:
          type: integer
        price:
          type: number
      required: [indexId, price]

    # ============================================
    # Files
    # ============================================
    BatchFileStatus:
      type: object
      properties:
        batchId:
          type: integer
        sources:
          type: array
          items:
            type: object
            properties:
              sourceId:
                type: integer
              sourceName:
                type: string
              files:
                type: array
                items:
                  type: object
                  properties:
                    fileSettingId:
                      type: integer
                    fileType:
                      type: string
                    status:
                      type: string
                      enum: [Pending, Processing, Valid, Failed]
                    fileName:
                      type: string
                      nullable: true
                    recordCount:
                      type: integer
                      nullable: true
                    error:
                      type: string
                      nullable: true

    FileSetting:
      type: object
      properties:
        id:
          type: integer
        fileSourceId:
          type: integer
        fileTypeId:
          type: integer
        fileName:
          type: string
        folder:
          type: string
        isActive:
          type: boolean
        frequency:
          type: string

    FileLog:
      type: object
      properties:
        id:
          type: integer
        reportBatchId:
          type: integer
        fileSettingId:
          type: integer
        folder:
          type: string
        fileName:
          type: string
        recordCount:
          type: integer
          nullable: true
        isValid:
          type: boolean

    FileLogList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/FileLog'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    FileUploadResponse:
      type: object
      properties:
        fileLogId:
          type: integer
        status:
          type: string
          enum: [Accepted, Processing]
        message:
          type: string

    # ============================================
    # Reference Data
    # ============================================
    AssetManager:
      type: object
      properties:
        id:
          type: integer
        externalCode:
          type: string
        code:
          type: string
        name:
          type: string
        chiefInvestmentOfficer:
          type: string
        chiefExecutiveOfficer:
          type: string
        clientRelationshipManager:
          type: string
        inceptionYear:
          type: integer
          nullable: true
        location:
          type: string
        bbbeeLevel:
          type: integer
          nullable: true
        webSite:
          type: string
        lastChangedUser:
          type: string

    CreateAssetManagerRequest:
      type: object
      properties:
        externalCode:
          type: string
        code:
          type: string
        name:
          type: string
        location:
          type: string
      required: [externalCode, code, name, location]

    Currency:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        code:
          type: string
        numeric:
          type: string

    Country:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        alpha2Code:
          type: string
        alpha3Code:
          type: string

    Index:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        code:
          type: string
        currencyId:
          type: integer

    Benchmark:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        code:
          type: string

    CreditRatingScale:
      type: object
      properties:
        id:
          type: integer
        description:
          type: string
        euCreditQualityStep:
          type: integer
        bbComp:
          type: string
        moodys:
          type: string
        sandP:
          type: string
        fitch:
          type: string

    # ============================================
    # Calculations
    # ============================================
    CalculationStatus:
      type: object
      properties:
        batchId:
          type: integer
        status:
          type: string
          enum: [NotStarted, InProgress, Completed, Failed]
        calculations:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              status:
                type: string
                enum: [Pending, Running, Completed, Failed]
              startTime:
                type: string
                format: date-time
                nullable: true
              endTime:
                type: string
                format: date-time
                nullable: true
              errorCount:
                type: integer

    CalculationError:
      type: object
      properties:
        id:
          type: integer
        calculationName:
          type: string
        errorCategory:
          type: string
        errorMessage:
          type: string
        timestamp:
          type: string
          format: date-time

    # ============================================
    # Report Comments
    # ============================================
    ReportComment:
      type: object
      properties:
        id:
          type: integer
        reportBatchId:
          type: integer
        reportListId:
          type: integer
        comment:
          type: string
        lastChangedUser:
          type: string
        validFrom:
          type: string
          format: date-time

    CreateReportCommentRequest:
      type: object
      properties:
        reportListId:
          type: integer
        comment:
          type: string
      required: [reportListId, comment]

    # ============================================
    # Audit
    # ============================================
    AuditTrailEntry:
      type: object
      properties:
        entityType:
          type: string
        entityId:
          type: integer
        changeType:
          type: string
          enum: [Created, Updated, Deleted]
        changedBy:
          type: string
        changedAt:
          type: string
          format: date-time
        changes:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
              oldValue:
                type: string
                nullable: true
              newValue:
                type: string
                nullable: true

    AuditTrailList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/AuditTrailEntry'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    # ============================================
    # Dashboard
    # ============================================
    PendingAction:
      type: object
      description: A pending action requiring the user's attention on the dashboard
      properties:
        id:
          type: string
          description: Unique identifier for this pending action
        type:
          type: string
          enum: [file_alert, validation, approval, master_data, admin]
          description: |
            Category of pending action:
            - file_alert: File upload/processing status (Analyst)
            - validation: Data validation issues (Analyst)
            - approval: Batches awaiting approval (ApproverL1/L2/L3)
            - master_data: Master data maintenance items (Analyst)
            - admin: User management and system config (Administrator)
        title:
          type: string
          description: Short summary of the pending action
        description:
          type: string
          description: Detailed description of what needs attention
        link:
          type: string
          description: Frontend route to navigate to for resolving this action
        priority:
          type: string
          enum: [high, medium, low]
          description: Priority level affecting display order and styling
      required: [id, type, title, description, link, priority]

    DashboardActivity:
      type: object
      description: A recent system activity entry for the dashboard activity feed
      properties:
        id:
          type: integer
          description: Unique identifier for this activity entry
        action:
          type: string
          description: Human-readable description of the action performed
        user:
          type: string
          description: Display name of the user who performed the action
        timestamp:
          type: string
          format: date-time
          description: When the action occurred
        entityType:
          type: string
          description: Type of entity affected (e.g., File, Batch, Instrument)
        entityId:
          type: integer
          description: ID of the affected entity
      required: [id, action, user, timestamp, entityType, entityId]

    DataQualitySummary:
      type: object
      description: |
        Aggregated counts of missing reference data across active batches.
        These counts represent instruments or indexes that are missing required
        data values needed before batch approval can proceed.
      properties:
        missingRatings:
          type: integer
          description: Count of instruments missing credit rating data
        missingDurations:
          type: integer
          description: Count of instruments missing duration values
        missingBetas:
          type: integer
          description: Count of instruments missing beta values
        missingIndexPrices:
          type: integer
          description: Count of indexes missing price data
      required: [missingRatings, missingDurations, missingBetas, missingIndexPrices]

    # ============================================
    # Login Activity Monitoring
    # ============================================
    LoginAttempt:
      type: object
      description: A single login attempt record from the UserLoginLog table
      properties:
        id:
          type: integer
          description: Unique login attempt ID
        timestamp:
          type: string
          format: date-time
          description: When the login attempt occurred
        username:
          type: string
          description: Username used in the attempt (may be "unknown" for non-existent users)
        userId:
          type: integer
          nullable: true
          description: User ID if the user exists, null otherwise
        displayName:
          type: string
          nullable: true
          description: User's display name if the user exists
        isSuccessful:
          type: boolean
          description: Whether the login attempt was successful
        status:
          type: string
          enum: [success, failed]
          description: Login attempt status
        ipAddress:
          type: string
          description: IP address of the login attempt
        location:
          type: string
          nullable: true
          description: Geolocation of the IP address (city/country for UK and South Africa regions, "Unknown" if lookup fails)
          example: London, UK
        userAgent:
          type: string
          nullable: true
          description: Browser and OS information from the User-Agent header
        failureReason:
          type: string
          nullable: true
          enum: [invalid_password, user_not_found, account_deactivated, account_locked, null]
          description: Reason for failure (null for successful logins)
        consecutiveFailureCount:
          type: integer
          nullable: true
          description: Number of consecutive failures for this user (null for successful logins)
        flags:
          type: array
          items:
            type: string
            enum: [new_location, impossible_travel, ip_blocked, brute_force_target]
          description: Security flags associated with this login attempt
        accountLocked:
          type: boolean
          description: Whether the account is currently locked
        lockExpiresAt:
          type: string
          format: date-time
          nullable: true
          description: When the account lockout expires (null if not locked)
      required: [id, timestamp, username, isSuccessful, status, ipAddress]

    LoginActivityList:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/LoginAttempt'
        meta:
          $ref: '#/components/schemas/PaginationMeta'
        summary:
          $ref: '#/components/schemas/LoginActivitySummary'

    LoginActivitySummary:
      type: object
      description: Summary counts for the current filter selection
      properties:
        successfulLogins:
          type: integer
          description: Count of successful login attempts
        failedAttempts:
          type: integer
          description: Count of failed login attempts
        lockedAccounts:
          type: integer
          description: Count of currently locked accounts
      required: [successfulLogins, failedAttempts, lockedAccounts]

    SecurityAlert:
      type: object
      description: A security alert generated from login activity analysis
      properties:
        id:
          type: integer
          description: Unique alert ID
        type:
          type: string
          enum: [multiple_failed_ip, account_locked, brute_force, new_location, impossible_travel]
          description: |
            Type of security alert:
            - multiple_failed_ip: 5+ failed attempts from same IP in 5 minutes
            - account_locked: Account locked after 3 consecutive failures
            - brute_force: 10+ failed attempts from different IPs in 1 hour
            - new_location: Login from a location never used before
            - impossible_travel: Logins from distant locations within 1 hour
        severity:
          type: string
          enum: [critical, warning, info]
          description: Alert severity level
        message:
          type: string
          description: Human-readable alert message
          example: "Multiple failed login attempts detected from IP 203.45.67.89"
        username:
          type: string
          nullable: true
          description: Affected username (if applicable)
        userId:
          type: integer
          nullable: true
          description: Affected user ID (if applicable)
        ipAddress:
          type: string
          nullable: true
          description: IP address involved (if applicable)
        location:
          type: string
          nullable: true
          description: Location involved (if applicable)
        createdAt:
          type: string
          format: date-time
          description: When the alert was generated
        isActive:
          type: boolean
          description: Whether the alert is still active/unresolved
        resolvedAt:
          type: string
          format: date-time
          nullable: true
          description: When the alert was resolved (null if still active)
        details:
          type: object
          description: Additional alert-specific details
          properties:
            attemptCount:
              type: integer
              description: Number of attempts that triggered the alert
            timeWindowMinutes:
              type: integer
              description: Time window in which attempts occurred
            lockExpiresAt:
              type: string
              format: date-time
              nullable: true
              description: When the lockout expires (for account_locked alerts)
            fromLocation:
              type: string
              nullable: true
              description: First location (for impossible_travel alerts)
            toLocation:
              type: string
              nullable: true
              description: Second location (for impossible_travel alerts)
      required: [id, type, severity, message, createdAt, isActive]

    SecurityAlertList:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/SecurityAlert'
        meta:
          $ref: '#/components/schemas/PaginationMeta'
